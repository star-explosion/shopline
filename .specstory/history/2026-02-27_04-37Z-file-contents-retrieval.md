<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session d420df67-f746-4317-971c-4af1492dddaa (2026-02-27 04:37Z) -->

# File contents retrieval (2026-02-27 04:37Z)

_**User**_

Read and return the FULL contents of these files from D:\Shopline\backend\:
1. src/index.ts
2. package.json
3. tsconfig.json
4. .env.example (if exists)
5. prisma/schema.prisma
6. prisma/seed.ts

Return the complete file contents for each, clearly labeled.

---

_**Agent (model composer-1, mode Agent)**_



---



---


正在读取这些文件的完整内容。


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: D:\Shopline\backend\src\index.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: D:\Shopline\backend\package.json</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: D:\Shopline\backend\tsconfig.json</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: D:\Shopline\backend\.env.example</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: D:\Shopline\backend\prisma\schema.prisma</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: D:\Shopline\backend\prisma\seed.ts</summary>

</details>
</tool-use>

---



---


以下是这些文件的完整内容：

---

## 1. src/index.ts

```1:37:D:\Shopline\backend\src\index.ts
import "dotenv/config";
import express from "express";
import cors from "cors";
import productRoutes from "./routes/products";
import orderRoutes from "./routes/orders";
import eventRoutes from "./routes/events";
import leadRoutes from "./routes/leads";
import adminRoutes from "./routes/admin";
import checkoutRoutes from "./routes/checkout";
import webhookRoutes from "./routes/webhook";

const app = express();
const PORT = process.env.PORT || 4000;

app.use(cors({ origin: process.env.FRONTEND_URL || "http://localhost:3000" }));

// Webhook must receive raw body for Stripe signature verification —
// mount BEFORE express.json() so the body is not parsed.
app.use("/api/webhook", express.raw({ type: "application/json" }), webhookRoutes);

app.use(express.json());

app.get("/health", (_req, res) => {
  res.json({ status: "ok" });
});

app.use("/api/products", productRoutes);
app.use("/api/orders", orderRoutes);
app.use("/api/events", eventRoutes);
app.use("/api/leads", leadRoutes);
app.use("/api/admin", adminRoutes);
app.use("/api/checkout", checkoutRoutes);

app.listen(PORT, () => {
  console.log(`Server running on http://localhost:${PORT}`);
});
```

---

## 2. package.json

```1:38:D:\Shopline\backend\package.json
{
  "name": "backend",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "dev": "ts-node --require dotenv/config src/index.ts",
    "build": "tsc",
    "start": "node dist/index.js",
    "postinstall": "prisma generate",
    "seed": "ts-node prisma/seed.ts",
    "db:migrate": "prisma migrate dev",
    "db:migrate:deploy": "prisma migrate deploy",
    "db:generate": "prisma generate"
  },
  "prisma": {
    "seed": "ts-node prisma/seed.ts"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "type": "commonjs",
  "dependencies": {
    "@prisma/client": "^7.4.1",
    "cors": "^2.8.6",
    "dotenv": "^17.3.1",
    "express": "^5.2.1",
    "prisma": "^7.4.1",
    "stripe": "^20.3.1"
  },
  "devDependencies": {
    "@types/cors": "^2.8.19",
    "@types/express": "^5.0.6",
    "@types/node": "^25.3.0",
    "ts-node": "^10.9.2",
    "typescript": "^5.9.3"
  }
}
```

---

## 3. tsconfig.json

```1:16:D:\Shopline\backend\tsconfig.json
{
  "compilerOptions": {
    "target": "ES2020",
    "module": "commonjs",
    "lib": ["ES2020"],
    "outDir": "./dist",
    "rootDir": "./src",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "forceConsistentCasingInFileNames": true,
    "resolveJsonModule": true
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules", "dist"]
}
```

---

## 4. .env.example

```1:20:D:\Shopline\backend\.env.example
# ─── Database (PostgreSQL) ────────────────────────────────────────────────────
# Railway provides this automatically when you add a PostgreSQL service.
# Format: postgresql://USER:PASSWORD@HOST:PORT/DATABASE
DATABASE_URL=postgresql://user:password@host:5432/dbname

# ─── Server ───────────────────────────────────────────────────────────────────
# Railway injects PORT automatically. Set to 4000 for local development.
PORT=4000

# ─── Stripe ───────────────────────────────────────────────────────────────────
# Get from https://dashboard.stripe.com/apikeys
STRIPE_SECRET_KEY=sk_live_...

# Get from https://dashboard.stripe.com/webhooks after creating the endpoint
STRIPE_WEBHOOK_SECRET=whsec_...

# ─── Frontend ─────────────────────────────────────────────────────────────────
# Your Vercel deployment URL (used for Stripe success/cancel redirects and CORS)
FRONTEND_URL=https://your-vercel-domain.vercel.app
```

---

## 5. prisma/schema.prisma

```1:69:D:\Shopline\backend\prisma\schema.prisma
generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String   @unique
  createdAt DateTime @default(now())
  orders    Order[]
}

model Product {
  id          Int         @id @default(autoincrement())
  name        String
  description String
  price       Float
  image       String
  images      String      @default("[]")
  stock       Int         @default(0)
  createdAt   DateTime    @default(now())
  orderItems  OrderItem[]
}

model Order {
  id              Int         @id @default(autoincrement())
  userId          Int
  user            User        @relation(fields: [userId], references: [id])
  status          String      @default("pending")
  totalPrice      Float
  stripeSessionId String?     @unique
  paymentIntentId String?
  createdAt       DateTime    @default(now())
  items           OrderItem[]
}

model OrderItem {
  id        Int     @id @default(autoincrement())
  orderId   Int
  order     Order   @relation(fields: [orderId], references: [id])
  productId Int
  product   Product @relation(fields: [productId], references: [id])
  quantity  Int
  price     Float
}

model Event {
  id        Int      @id @default(autoincrement())
  type      String
  productId Int?
  sessionId String
  userAgent String
  createdAt DateTime @default(now())
}

model Lead {
  id        Int      @id @default(autoincrement())
  contact   String
  source    String   @default("popup")
  locale    String   @default("zh")
  createdAt DateTime @default(now())
}
```

---

## 6. prisma/seed.ts

```1:65:D:\Shopline\backend\prisma\seed.ts
import path from "path";
import { PrismaClient } from "../generated/prisma";
import { PrismaBetterSqlite3 } from "@prisma/adapter-better-sqlite3";

const dbPath = path.resolve(__dirname, "../prisma/dev.db");
const adapter = new PrismaBetterSqlite3({ url: dbPath });
const prisma = new PrismaClient({ adapter });

async function main() {
  // Clear existing data in correct order (foreign key constraints)
  await prisma.orderItem.deleteMany();
  await prisma.order.deleteMany();
  await prisma.product.deleteMany();
  await prisma.user.deleteMany();

  await prisma.user.create({
    data: { name: "Guest User", email: "guest@royalbaland.com" },
  });

  const products = [
    {
      name: "云感乳胶弹簧床垫（R-666）",
      description:
        "甄选比利时进口天然乳胶与独立袋装弹簧复合而成，回弹迅速，贴合人体曲线，无干扰睡眠。面料采用美国杜邦特立珑纺织工艺，全年恒温舒适。搭配百兰专利双盈舒适树脂棉与高弹性七孔纤维棉，精准承托腰椎与肩颈。",
      price: 3999,
      image: "/images/R666-1.png",
      images: JSON.stringify(["/images/R666-1.png", "/images/R666-2.png"]),
      stock: 50,
    },
    {
      name: "酒店专供硬感床垫（R-888）",
      description:
        "五星级酒店标配款，采用美国礼恩派（Leggett & Platt）高碳钢弹簧体系，承重均匀，边缘强化不塌陷。经西安万豪、深圳温德姆等国际酒店长期采购验证，耐用性卓越。硬而不硬，提供坚定而有弹性的支撑体验。",
      price: 2499,
      image: "/images/R888-1.png",
      images: JSON.stringify(["/images/R888-1.png", "/images/R888-2.png"]),
      stock: 80,
    },
    {
      name: "豪华旗舰乳胶床垫（R-999）",
      description:
        "皇室百兰顶级工艺旗舰之作。采用比利时贝卡特进口面料、比利时天然乳胶与美国礼恩派高碳钢弹簧三层复合技术，内含百兰专利双盈舒适树脂棉。通过ISO9001与ISO14001双认证，每一张均经过床垫滚压测试机严格检测出厂。国宾馆同款品质。",
      price: 5999,
      image: "/images/R999-1.png",
      images: JSON.stringify(["/images/R999-1.png", "/images/R999-2.png"]),
      stock: 20,
    },
  ];

  for (const product of products) {
    await prisma.product.create({ data: product });
  }

  console.log("皇室百兰 seed data inserted successfully.");
}

main()
  .catch((e) => {
    console.error(e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
```

---

所有文件已读取完成。注意：`seed.ts` 使用了 SQLite 适配器（`PrismaBetterSqlite3`），但 `schema.prisma` 配置为 PostgreSQL，可能存在不一致。

---


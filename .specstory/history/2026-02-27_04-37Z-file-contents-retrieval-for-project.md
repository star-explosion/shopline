<!-- Generated by SpecStory, Markdown v2.1.0 -->

<!-- cursor Session 1798f094-2380-412f-87cc-5006dce47d43 (2026-02-27 04:37Z) -->

# File contents retrieval for project (2026-02-27 04:37Z)

_**User**_

Read and return the FULL contents of these files:
1. D:\Shopline\frontend\app\sitemap.ts
2. D:\Shopline\frontend\app\[locale]\admin\page.tsx
3. D:\Shopline\frontend\components\LeadCaptureModal.tsx
4. D:\Shopline\frontend\components\LpLeadForm.tsx
5. D:\Shopline\frontend\lib\api.ts
6. D:\Shopline\frontend\app\[locale]\products\[id]\ProductDetailClient.tsx (specifically look for checkout/stripe related code)
7. D:\Shopline\backend\src\routes\checkout.ts
8. D:\Shopline\backend\src\routes\webhook.ts

Return the full file contents for each, clearly labeled with the file path.

---

_**Agent (model composer-1, mode Agent)**_



---



---


正在读取这些文件的完整内容。


---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: D:\Shopline\frontend\app\sitemap.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: D:\Shopline\frontend\app\[locale]\admin\page.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: D:\Shopline\frontend\components\LeadCaptureModal.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: D:\Shopline\frontend\components\LpLeadForm.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: D:\Shopline\frontend\lib\api.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: D:\Shopline\frontend\app\[locale]\products\[id]\ProductDetailClient.tsx</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: D:\Shopline\backend\src\routes\checkout.ts</summary>

</details>
</tool-use>

---

<tool-use data-tool-type="read" data-tool-name="read_file_v2">
<details><summary>Tool use: **read_file_v2** • Read file: D:\Shopline\backend\src\routes\webhook.ts</summary>

</details>
</tool-use>

---



---


已读取所有文件，内容如下：

---

## 1. D:\Shopline\frontend\app\sitemap.ts

```1:47:D:\Shopline\frontend\app\sitemap.ts
import { MetadataRoute } from "next";

const BASE_URL = process.env.NEXT_PUBLIC_SITE_URL || "https://royalsleep.com";
const locales = ["zh", "en", "ja"];

const staticPaths = ["", "/products", "/brand"];

async function getProductIds(): Promise<number[]> {
  try {
    const res = await fetch(
      `${process.env.NEXT_PUBLIC_API_URL || "http://localhost:4000"}/api/products?limit=100`,
      { next: { revalidate: 3600 } }
    );
    if (!res.ok) return [];
    const data = await res.json();
    return (data.products || []).map((p: { id: number }) => p.id);
  } catch {
    return [];
  }
}

export default async function sitemap(): Promise<MetadataRoute.Sitemap> {
  const productIds = await getProductIds();
  const entries: MetadataRoute.Sitemap = [];

  for (const locale of locales) {
    for (const path of staticPaths) {
      entries.push({
        url: `${BASE_URL}/${locale}${path}`,
        lastModified: new Date(),
        changeFrequency: path === "" ? "daily" : "weekly",
        priority: path === "" ? 1.0 : 0.8,
      });
    }
    for (const id of productIds) {
      entries.push({
        url: `${BASE_URL}/${locale}/products/${id}`,
        lastModified: new Date(),
        changeFrequency: "weekly",
        priority: 0.7,
      });
    }
  }

  return entries;
}
```

---

## 2. D:\Shopline\frontend\app\[locale]\admin\page.tsx

```1:74:D:\Shopline\frontend\app\[locale]\admin\page.tsx
import { getTranslations } from "next-intl/server";
import AdminDashboardClient from "./AdminDashboardClient";

const API = process.env.NEXT_PUBLIC_API_URL || "http://localhost:4000";

interface FunnelStep {
  step: string;
  count: number;
}

interface Lead {
  id: number;
  contact: string;
  source: string;
  locale: string;
  createdAt: string;
}

interface Stats {
  totalOrders: number;
  revenue: number;
  leadsCount: number;
  funnel: FunnelStep[];
  recentLeads: Lead[];
}

interface Props {
  params: Promise<{ locale: string }>;
}

export default async function AdminPage({ params }: Props) {
  const { locale } = await params;
  const t = await getTranslations({ locale, namespace: "admin" });

  let stats: Stats = {
    totalOrders: 0,
    revenue: 0,
    leadsCount: 0,
    funnel: [],
    recentLeads: [],
  };

  try {
    const res = await fetch(`${API}/api/admin/stats`, { cache: "no-store" });
    if (res.ok) stats = await res.json();
  } catch {
    // backend may not be running
  }

  const totalVisits = stats.funnel.find((f) => f.step === "view_homepage")?.count ?? 0;
  const productViews = stats.funnel.find((f) => f.step === "view_product")?.count ?? 0;

  return (
    <AdminDashboardClient
      stats={stats}
      totalVisits={totalVisits}
      productViews={productViews}
      labels={{
        title: t("title"),
        totalVisits: t("totalVisits"),
        productViews: t("productViews"),
        orders: t("orders"),
        revenue: t("revenue"),
        funnelTitle: t("funnelTitle"),
        leadsTitle: t("leadsTitle"),
        contact: t("contact"),
        source: t("source"),
        locale: t("locale"),
        time: t("time"),
      }}
    />
  );
}
```

---

## 3. D:\Shopline\frontend\components\LeadCaptureModal.tsx

```1:141:D:\Shopline\frontend\components\LeadCaptureModal.tsx
"use client";

import { useEffect, useState, useRef } from "react";
import { useLocale, useTranslations } from "next-intl";
import { XMarkIcon } from "@heroicons/react/24/outline";

const API = process.env.NEXT_PUBLIC_API_URL || "http://localhost:4000";
const SESSION_KEY = "_rs_lead_shown";

export default function LeadCaptureModal() {
  const [visible, setVisible] = useState(false);
  const [contact, setContact] = useState("");
  const [loading, setLoading] = useState(false);
  const [success, setSuccess] = useState(false);
  const [error, setError] = useState("");
  const timerRef = useRef<ReturnType<typeof setTimeout> | null>(null);
  const locale = useLocale();
  const t = useTranslations("lead");

  useEffect(() => {
    // Only show once per session
    if (typeof window === "undefined") return;
    try {
      if (sessionStorage.getItem(SESSION_KEY)) return;
    } catch {
      return;
    }

    // 30-second timer trigger
    timerRef.current = setTimeout(() => show(), 30000);

    // Exit intent trigger
    function handleMouseLeave(e: MouseEvent) {
      if (e.clientY <= 0) show();
    }
    document.addEventListener("mouseleave", handleMouseLeave);

    return () => {
      if (timerRef.current) clearTimeout(timerRef.current);
      document.removeEventListener("mouseleave", handleMouseLeave);
    };
  }, []);

  function show() {
    try {
      if (sessionStorage.getItem(SESSION_KEY)) return;
    } catch {}
    setVisible(true);
    if (timerRe

---

